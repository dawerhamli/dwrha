{% extends 'base.html' %}
{% load static %}

{% block title %}Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø¤Ø«Ø±ÙŠÙ†{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo fade-in">
    <h1 class="hero-title fade-in">â­ Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ù…Ù†ØµØªÙƒ Ù„Ø§Ø¨ØªÙƒØ§Ø± ØªØ¬Ø§Ø±Ø¨ ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø¹ Ù…ØªØ§Ø¨Ø¹ÙŠÙƒ</h1>
    <p class="fade-in">Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ù†Ø§ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø®Ø§ØµØ© Ù…Ø¹ Ø¹Ø¬Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ¬ÙˆØ§Ø¦Ø²Ùƒ Ø§Ù„Ø®Ø§ØµØ© âœ¨</p>
</header>

<!-- Registration Form -->
<section class="form-section fade-in" id="form">
    <h2>Ø³Ø¬Ù‘Ù„ Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ</h2>
    <p class="form-note">â­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¤Ø«Ø±ÙŠÙ† ÙÙ‚Ø·</p>
    
    <form id="leadForm" class="form">
        {% csrf_token %}
        <div class="grid">
            <label>
                Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø«Ø±
                <input type="text" name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø«Ø±" required>
            </label>

            <label>
                Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                <input type="text" name="username" placeholder="@username" required>
            </label>

            <label>
                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                <input type="email" name="email" placeholder="example@email.com" required>
            </label>

            <label>
                Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„
                <input type="tel" name="phone" placeholder="05XXXXXXXX">
            </label>

            <label>
                Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
                <input type="number" name="followers_count" min="0" placeholder="0" value="0">
            </label>

            <label class="full">
                Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input type="url" name="profile_url" placeholder="https://...">
            </label>

            <label class="full">
                Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØ§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø§Ù„ÙÙˆØ² (Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
                <small style="display: block; color: #6c757d; margin-bottom: 10px; font-size: 13px;">
                    ğŸ’¡ ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ø²Ø§Ø¯ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ÙÙˆØ² Ø¨Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ù† 1% Ø¥Ù„Ù‰ 100%)
                </small>
                <div id="prizesContainer" style="margin-top: 10px;">
                    <div class="prize-item" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef;">
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center;">
                            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 80px; text-align: center;">
                                <span style="font-weight: bold; color: #6A3FA0; font-size: 15px;">%</span>
                            </div>
                            <button type="button" class="remove-prize-btn" style="background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; min-width: 70px;">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="addPrizeBtn" style="margin-top: 10px; background: #6A3FA0; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700;">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø©</button>
                <div id="totalPercentage" style="margin-top: 10px; padding: 12px; background: #e3f2fd; border-radius: 10px; font-weight: bold; color: #1565c0; text-align: center; font-size: 15px;">
                    Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">50</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                </div>
            </label>
        </div>

        <button type="submit" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Hide platform field if it exists (for cache issues)
(function() {
    function hidePlatformField() {
        // Remove any label containing "Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" or "Ø§Ù„Ù…Ù†ØµØ©"
        const allLabels = document.querySelectorAll('label');
        allLabels.forEach(label => {
            const text = (label.textContent || label.innerText || '').trim();
            if (text.includes('Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') || text.includes('Ø§Ù„Ù…Ù†ØµØ©') && text.length < 50) {
                label.style.display = 'none';
                label.remove();
            }
        });
        
        // Remove any select elements with platform
        const platformSelects = document.querySelectorAll('select[name="platform"], select[id*="platform"], select[id*="Platform"], select[id*="platformSelect"]');
        platformSelects.forEach(select => {
            const container = select.closest('label') || select.parentElement || select.closest('div');
            if (container) {
                container.style.display = 'none';
                container.remove();
            } else {
                select.style.display = 'none';
                select.remove();
            }
        });
        
        // Remove platformContainer divs
        const platformContainers = document.querySelectorAll('#platformContainer, [id*="platform"], [id*="Platform"]');
        platformContainers.forEach(container => {
            const parent = container.closest('label') || container.parentElement;
            if (parent) {
                parent.style.display = 'none';
                parent.remove();
            } else {
                container.style.display = 'none';
                container.remove();
            }
        });
    }
    
    // Run immediately
    hidePlatformField();
    
    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hidePlatformField);
    } else {
        hidePlatformField();
    }
    
    // Run after a short delay to catch dynamically added elements
    setTimeout(hidePlatformField, 100);
    setTimeout(hidePlatformField, 500);
})();

/**
 * Show notification message
 */
function showNotification(message, type = "info") {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        ">
            ${message}
        </div>
    `;

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

/**
 * Handle prize management
 */
const prizesContainer = document.getElementById('prizesContainer');
const addPrizeBtn = document.getElementById('addPrizeBtn');
const totalPercentValue = document.getElementById('totalPercentValue');

function updateTotalPercentage() {
    const percentages = Array.from(document.querySelectorAll('.prize-percentage'))
        .map(input => parseInt(input.value) || 0);
    const total = percentages.reduce((sum, val) => sum + val, 0);
    totalPercentValue.textContent = total;
    
    const totalDiv = document.getElementById('totalPercentage');
    // Maintain consistent styling
    totalDiv.style.borderRadius = '10px';
    totalDiv.style.padding = '12px';
    totalDiv.style.fontSize = '15px';
    
    if (total > 0) {
        totalDiv.style.background = '#e3f2fd';
        totalDiv.style.color = '#1565c0';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">${total}</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`;
    } else {
        totalDiv.style.background = '#fff3cd';
        totalDiv.style.color = '#856404';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">0</span>% (ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ©)`;
    }
}

function addPrizeItem() {
    const prizeItem = document.createElement('div');
    prizeItem.className = 'prize-item';
    prizeItem.style.cssText = 'margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef; position: relative;';
    
    prizeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center;">
            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required>
            <div style="display: flex; align-items: center; gap: 6px;">
                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 80px; text-align: center;">
                <span style="font-weight: bold; color: #6A3FA0; font-size: 15px;">%</span>
            </div>
            <button type="button" class="remove-prize-btn" style="background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; min-width: 70px;">Ø­Ø°Ù</button>
        </div>
    `;
    
    prizesContainer.appendChild(prizeItem);
    
    prizeItem.querySelector('.prize-percentage').addEventListener('input', updateTotalPercentage);
    prizeItem.querySelector('.remove-prize-btn').addEventListener('click', () => {
        if (document.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
            updateTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
    
    updateTotalPercentage();
}

addPrizeBtn.addEventListener('click', addPrizeItem);

// Add event listeners to existing prize items
document.querySelectorAll('.prize-percentage').forEach(input => {
    input.addEventListener('input', updateTotalPercentage);
});

document.querySelectorAll('.remove-prize-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const prizeItem = this.closest('.prize-item');
        if (document.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
            updateTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
});

updateTotalPercentage();

// Override form submission for influencers
const form = document.getElementById("leadForm");
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Collect prizes with percentages
    const prizes = [];
    const percentages = [];
    document.querySelectorAll('.prize-item').forEach(item => {
        const name = item.querySelector('.prize-name').value.trim();
        const percentage = parseInt(item.querySelector('.prize-percentage').value);
        if (name && percentage) {
            prizes.push(name);
            percentages.push(percentage);
        }
    });
    
    if (prizes.length === 0) {
        showNotification('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', "error");
        return;
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

    try {
        const formData = new FormData(form);
        
        const data = {
            name: formData.get('name'),
            platform: 'other',  // Default value
            customPlatform: '',
            username: formData.get('username'),
            profile_url: formData.get('profile_url'),
            followers_count: formData.get('followers_count') || 0,
            email: formData.get('email'),
            phone: formData.get('phone'),
            prizes: prizes,
            prize_percentages: percentages
        };

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const response = await fetch('{% url "influencers:register" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            try {
                const errorData = JSON.parse(errorText);
                showNotification(errorData.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', "error");
            } catch (e) {
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (${response.status})`, "error");
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message || 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­', "success");
            setTimeout(() => {
                if (result.redirect_url) {
                    window.location.href = result.redirect_url;
                } else {
                    window.location.href = `/influencers/thanks/${result.influencer_id}/`;
                }
            }, 2000);
        } else {
            showNotification(result.message, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }

    } catch (error) {
        console.error('Error submitting form:', error);
        showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}`, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}

