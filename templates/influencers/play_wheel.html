{% extends 'base.html' %}
{% load static %}

{% block title %}Ø§Ù„Ø¹Ø¬Ù„Ø© - {{ influencer.name }} | Ø¯ÙˆÙ‘Ø±Ù‡Ø§{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo fade-in">
    <h1 class="hero-title fade-in">ğŸ¡ Ø¹Ø¬Ù„Ø© {{ influencer.name }}</h1>
    <p class="fade-in">Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ù„ÙØ§Ø¦Ø² Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ âœ¨</p>
</header>

<!-- Main Content -->
<main class="stage play-wheel-stage">
    <!-- Statistics Boxes - ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
    <div class="stats-container welcome-stats">
        <div class="stat-box stat-box-1">
            <div class="stat-number" id="participantsCount">{{ participants_count }}</div>
            <div class="stat-label">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</div>
        </div>
        <div class="stat-box stat-box-prizes stat-box-2">
            <div class="stat-number" id="prizesCount">{{ prizes|length }}</div>
            <div class="stat-label">ğŸ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</div>
        </div>
    </div>

    <!-- Prize order control -->
    <section class="prize-order-card">
        <div class="prize-order-header">
            <h2>ØªØ±ØªÙŠØ¨ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¬Ù„Ø©</h2>
            <p class="prize-order-hint">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø£Ùˆ Ø§Ù„Ø£Ø³ÙÙ„ Ù„ØªØºÙŠÙŠØ± ØªØ±ØªÙŠØ¨ Ø¸Ù‡ÙˆØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¬Ù„Ø©.
                Ø¥Ø°Ø§ Ù„Ù… ØªØºÙŠÙ‘Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø£Ùˆ Ø¹Ø·Ù‘Ù„Øª Ø§Ù„Ø®ÙŠØ§Ø±ØŒ ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹.
            </p>
        </div>
        <label class="prize-order-toggle">
            <input type="checkbox" id="enablePrizeOrder" checked>
            <span>ØªÙØ¹ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¬Ù„Ø©)</span>
        </label>
        <ul id="prizeOrderList" class="prize-order-list">
            <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ù…Ù† JavaScript -->
        </ul>
    </section>
    
    <!-- Wheel Section -->
    <div id="wheelSection" class="wheel-wrap welcome-wheel">
        <div class="wheel-container">
            <div class="needle"></div>
            <canvas id="wheelCanvas" width="560" height="560"></canvas>
        </div>
        <button id="spinBtn" class="btn primary spin-btn welcome-spin-btn">Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© ğŸ¡</button>
        <div id="resultText" class="result-area"></div>
    </div>
</main>
{% endblock %}

{% block extra_css %}
<style>
/* ØªØ±Ø­ÙŠØ¨ÙŠØ© - Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ */
@keyframes welcomeStat1 {
  0% { opacity: 0; transform: translateX(-80px) scale(0.5); }
  60% { opacity: 1; transform: translateX(8px) scale(1.08); }
  100% { opacity: 1; transform: translateX(0) scale(1); }
}
@keyframes welcomeStat2 {
  0% { opacity: 0; transform: translateX(80px) scale(0.5); }
  60% { opacity: 1; transform: translateX(-8px) scale(1.08); }
  100% { opacity: 1; transform: translateX(0) scale(1); }
}
@keyframes welcomeWheel {
  0% { opacity: 0; transform: scale(0.3); filter: blur(8px); }
  50% { opacity: 1; transform: scale(1.05); filter: blur(0); }
  100% { opacity: 1; transform: scale(1); filter: blur(0); }
}
@keyframes welcomeNumber {
  0% { opacity: 0; transform: scale(0) rotate(-10deg); }
  70% { opacity: 1; transform: scale(1.15) rotate(2deg); }
  100% { opacity: 1; transform: scale(1) rotate(0); }
}
@keyframes welcomeGlow {
  0% { box-shadow: 0 8px 20px rgba(106, 63, 160, 0.3); }
  40% { box-shadow: 0 14px 40px rgba(106, 63, 160, 0.5), 0 0 25px rgba(106, 63, 160, 0.25); }
  100% { box-shadow: 0 8px 20px rgba(106, 63, 160, 0.3); }
}
@keyframes welcomeGlowPrizes {
  0% { box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3); }
  40% { box-shadow: 0 14px 40px rgba(255, 107, 157, 0.5), 0 0 25px rgba(255, 107, 157, 0.25); }
  100% { box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3); }
}
@keyframes welcomeBtn {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

.play-wheel-stage .stats-container { display: flex; gap: 20px; justify-content: center; margin: 30px auto; max-width: 800px; flex-wrap: wrap; }
.play-wheel-stage .stat-box { background: linear-gradient(135deg, #6A3FA0 0%, #8C59C4 100%); color: white; padding: 25px 40px; border-radius: 15px; text-align: center; min-width: 180px; opacity: 0; }
.play-wheel-stage .stat-box-1 { animation: welcomeStat1 0.5s ease-out forwards, welcomeGlow 1.5s ease-in-out 0.5s; }
.play-wheel-stage .stat-box-2 { animation: welcomeStat2 0.5s ease-out 0.1s forwards, welcomeGlowPrizes 1.5s ease-in-out 0.6s; }
.play-wheel-stage .stat-box-prizes { background: linear-gradient(135deg, #FF6B9D 0%, #FF8B5A 100%); }
.play-wheel-stage .stat-number { font-size: clamp(36px, 6vw, 48px); font-weight: 900; margin-bottom: 8px; animation: welcomeNumber 0.6s ease-out 0.2s both; }
.play-wheel-stage .stat-box-2 .stat-number { animation-delay: 0.3s; }
.play-wheel-stage .stat-label { font-size: clamp(14px, 2.5vw, 18px); opacity: 0.95; }
.play-wheel-stage .wheel-wrap { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
.play-wheel-stage .wheel-wrap.welcome-wheel .wheel-container { animation: welcomeWheel 0.6s ease-out 0.35s both; }
.play-wheel-stage .wheel-container { position: relative; width: min(92vw, 520px); max-width: 520px; aspect-ratio: 1; }
.play-wheel-stage .wheel-container canvas { width: 100% !important; height: 100% !important; max-width: 100%; border-radius: 50%; display: block; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
.play-wheel-stage .needle { position: absolute; top: -8px; right: 50%; transform: translateX(50%); width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent; border-bottom: 24px solid #2F1D52; z-index: 5; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); }
.play-wheel-stage .spin-btn { font-size: clamp(16px, 3vw, 20px); padding: 16px 36px; font-weight: 800; min-width: 200px; }
.play-wheel-stage .welcome-spin-btn { animation: welcomeBtn 0.4s ease-out 0.7s both; }
.play-wheel-stage .result-area { width: 100%; max-width: 500px; margin-top: 10px; }
.play-wheel-stage .result-card { background: #fff; padding: 28px 24px; border-radius: 16px; text-align: center; border: 3px solid #28a745; box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2); }
.play-wheel-stage .result-card h2 { color: #155724; margin: 0 0 16px; font-size: clamp(22px, 4vw, 28px); font-weight: 900; }
.play-wheel-stage .result-prize { font-size: clamp(18px, 3vw, 22px); font-weight: 700; color: #155724; margin: 12px 0; }
.play-wheel-stage .result-winner { background: #f8f9fa; padding: 18px; border-radius: 12px; margin: 18px 0; text-align: right; }
.play-wheel-stage .result-winner p { margin: 8px 0; font-size: clamp(15px, 2.5vw, 17px); color: #333; font-weight: 600; }
.play-wheel-stage .spin-again-btn { margin-top: 22px; padding: 18px 40px; font-size: 18px; font-weight: 800; background: linear-gradient(135deg, #6A3FA0 0%, #8C59C4 100%); color: white; border: none; border-radius: 14px; cursor: pointer; box-shadow: 0 6px 20px rgba(106, 63, 160, 0.4); transition: transform 0.2s, box-shadow 0.2s; }
.play-wheel-stage .spin-again-btn:hover { transform: scale(1.05); box-shadow: 0 8px 28px rgba(106, 63, 160, 0.5); }
.play-wheel-stage .spin-again-btn:active { transform: scale(0.98); }

/* Prize order list */
.play-wheel-stage .prize-order-card {
  margin: 10px auto 0;
  max-width: 520px;
  background: #fff;
  border-radius: 16px;
  padding: 16px 18px 10px;
  box-shadow: 0 8px 22px rgba(0,0,0,0.06);
}
.play-wheel-stage .prize-order-header h2 {
  margin: 0 0 6px;
  font-size: 18px;
  font-weight: 800;
  color: #2F1D52;
}
.play-wheel-stage .prize-order-hint {
  margin: 0 0 10px;
  font-size: 13px;
  color: #6c757d;
}
.play-wheel-stage .prize-order-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  font-size: 13px;
  color: #444;
}
.play-wheel-stage .prize-order-toggle input[type="checkbox"] {
  width: 16px;
  height: 16px;
}
.play-wheel-stage .prize-order-toggle span {
  cursor: pointer;
}
.play-wheel-stage .prize-order-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.play-wheel-stage .prize-order-list.disabled {
  opacity: 0.5;
  pointer-events: none;
}
.play-wheel-stage .prize-order-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  border-radius: 10px;
  background: #f8f9fd;
  border: 1px solid rgba(106,63,160,0.12);
}
.play-wheel-stage .prize-order-main {
  display: flex;
  align-items: center;
  gap: 10px;
}
.play-wheel-stage .prize-order-index {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: #6A3FA0;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 14px;
}
.play-wheel-stage .prize-order-text {
  font-size: 14px;
  font-weight: 600;
  color: #2F1D52;
}
.play-wheel-stage .prize-order-actions {
  display: flex;
  gap: 4px;
}
.play-wheel-stage .prize-move-btn {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 800;
  background: #eee;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s, transform 0.1s;
}
.play-wheel-stage .prize-move-btn:hover {
  background: #ddd;
  transform: translateY(-1px);
}
.play-wheel-stage .prize-move-btn:active {
  transform: translateY(0);
}
/* Responsive tweaks Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 720px) {
  .play-wheel-stage .stats-container {
    flex-direction: column;
    align-items: stretch;
    max-width: 100%;
    padding: 0 10px;
  }
  .play-wheel-stage .stat-box {
    width: 100%;
    min-width: auto;
    padding: 18px 20px;
  }
  .play-wheel-stage .prize-order-card {
    margin-inline: 10px;
    padding: 14px 14px 8px;
  }
  .play-wheel-stage .wheel-wrap {
    padding-inline: 8px;
    gap: 14px;
  }
  .play-wheel-stage .result-area {
    padding-inline: 4px;
  }
}
@media (max-width: 480px) {
  .play-wheel-stage .stat-box {
    min-width: auto;
    padding: 16px 18px;
  }
  .play-wheel-stage .wheel-container {
    width: min(96vw, 380px);
  }
  .play-wheel-stage .result-card {
    padding: 20px 16px;
  }
  .play-wheel-stage .result-winner {
    padding: 14px;
  }
  .play-wheel-stage .spin-again-btn,
  .play-wheel-stage .welcome-spin-btn {
    width: 100%;
    padding-inline: 0;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Game data
const influencerToken = "{{ encrypted_token }}";
const prizes = {{ prizes|safe }}.map(p => (p || '').toString().trim()).filter(p => p);
const colors = {{ colors|safe }};

// DOM Elements
const wheelSection = document.getElementById("wheelSection");
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas?.getContext("2d");
const spinBtn = document.getElementById("spinBtn");
const resultText = document.getElementById("resultText");
const participantsCountEl = document.getElementById("participantsCount");
const prizesCountEl = document.getElementById("prizesCount");
const prizeOrderList = document.getElementById("prizeOrderList");
const enablePrizeOrder = document.getElementById("enablePrizeOrder");

let spinning = false;
let rotation = 0;
let animationFrame = null;
let remainingPrizesCount = prizes.length;
const originalPrizes = prizes.slice();
let wheelPrizes = originalPrizes.slice(); // Ù†Ø³Ø®Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¬Ù„Ø©
let customOrder = false;

function renderPrizeOrderList() {
    if (!prizeOrderList) return;
    prizeOrderList.innerHTML = '';
    wheelPrizes.forEach((prize, index) => {
        const li = document.createElement('li');
        li.className = 'prize-order-item';
        li.innerHTML = `
            <div class="prize-order-main">
                <span class="prize-order-index">${index + 1}</span>
                <span class="prize-order-text">${prize || ''}</span>
            </div>
            <div class="prize-order-actions">
                <button type="button" class="prize-move-btn up" data-dir="up" aria-label="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>
                <button type="button" class="prize-move-btn down" data-dir="down" aria-label="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„">â†“</button>
            </div>
        `;
        prizeOrderList.appendChild(li);

        const upBtn = li.querySelector('.prize-move-btn.up');
        const downBtn = li.querySelector('.prize-move-btn.down');

        upBtn.addEventListener('click', () => {
            if (index === 0) return;
            customOrder = true;
            const tmp = wheelPrizes[index - 1];
            wheelPrizes[index - 1] = wheelPrizes[index];
            wheelPrizes[index] = tmp;
            renderPrizeOrderList();
            drawWheel();
        });

        downBtn.addEventListener('click', () => {
            if (index === wheelPrizes.length - 1) return;
            customOrder = true;
            const tmp = wheelPrizes[index + 1];
            wheelPrizes[index + 1] = wheelPrizes[index];
            wheelPrizes[index] = tmp;
            renderPrizeOrderList();
            drawWheel();
        });
    });
}

function applyPrizeOrderMode() {
    if (!enablePrizeOrder) return;
    if (enablePrizeOrder.checked) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ…Ø§ Ù‡Ùˆ
        prizeOrderList?.classList.remove('disabled');
    } else {
        // ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        wheelPrizes = originalPrizes.slice();
        if (wheelPrizes.length > 1) {
            for (let i = wheelPrizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [wheelPrizes[i], wheelPrizes[j]] = [wheelPrizes[j], wheelPrizes[i]];
            }
        }
        prizeOrderList?.classList.add('disabled');
    }
    renderPrizeOrderList();
    drawWheel();
}

/**
 * Draw Wheel - clear text, responsive
 */
function drawWheel() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const numSeg = wheelPrizes.length;
    const arc = (2 * Math.PI) / numSeg;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 10;

    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(rotation);

    for (let i = 0; i < numSeg; i++) {
        ctx.beginPath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, radius, i * arc, (i + 1) * arc);
        ctx.lineTo(0, 0);
        ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,0.9)";
        ctx.lineWidth = 4;
        ctx.stroke();

        ctx.save();
        ctx.rotate(i * arc + arc / 2);
        const maxWidth = radius - 55;
        const prizeText = wheelPrizes[i];
        let fontSize = Math.min(24, Math.floor(radius / 8));
        ctx.font = `bold ${fontSize}px Cairo`;
        let textWidth = ctx.measureText(prizeText).width;
        if (textWidth > maxWidth) {
            fontSize = Math.max(14, Math.floor((maxWidth / textWidth) * fontSize));
            ctx.font = `bold ${fontSize}px Cairo`;
            textWidth = ctx.measureText(prizeText).width;
        }
        ctx.fillStyle = "#fff";
        ctx.textAlign = "right";
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 6;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        if (textWidth > maxWidth) {
            const words = prizeText.split(' ');
            const lines = [];
            let currentLine = '';
            for (let word of words) {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                if (ctx.measureText(testLine).width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else currentLine = testLine;
            }
            if (currentLine) lines.push(currentLine);
            const lh = fontSize + 5;
            const startY = -(lines.length * lh) / 2 + lh / 2;
            lines.forEach((line, j) => {
                ctx.strokeStyle = "rgba(0,0,0,0.9)";
                ctx.lineWidth = 4;
                ctx.strokeText(line, radius - 25, startY + j * lh);
                ctx.fillStyle = "#fff";
                ctx.fillText(line, radius - 25, startY + j * lh);
            });
        } else {
            ctx.strokeStyle = "rgba(0,0,0,0.9)";
            ctx.lineWidth = 4;
            ctx.strokeText(prizeText, radius - 25, 12);
            ctx.fillStyle = "#fff";
            ctx.fillText(prizeText, radius - 25, 12);
        }
        ctx.shadowColor = "transparent";
        ctx.restore();
    }
    ctx.restore();

    ctx.beginPath();
    ctx.arc(centerX, centerY, 35, 0, 2 * Math.PI);
    ctx.fillStyle = "#2F1D52";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 5;
    ctx.stroke();
}

/**
 * Spin Wheel
 */
async function spinWheel() {
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    spinBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†... â³';
    resultText.innerHTML = '';

    try {
        const response = await fetch(`/influencers/spin/${influencerToken}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const result = await response.json();
        
        if (!result.success) {
            alert(result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†');
            spinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© ğŸ¡';
            return;
        }

        const wonPrize = (result.prize || '').trim();
        const winner = result.winner;
        
        // Find prize index Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
        const normalizedPrizes = wheelPrizes.map(p => (p || '').toString().trim());
        let prizeIndex = normalizedPrizes.indexOf(wonPrize);
        
        if (prizeIndex === -1) {
            prizeIndex = normalizedPrizes.findIndex(p => p.toLowerCase() === wonPrize.toLowerCase());
        }
        
        if (prizeIndex === -1) {
            prizeIndex = 0; // Fallback to first prize
        }

        // Calculate target rotation (prize at top, then rotate to show at bottom)
        const arc = (2 * Math.PI) / wheelPrizes.length;
        const targetPrizeAngle = prizeIndex * arc + arc / 2;
        // Position prize at bottom (270 degrees = 3Ï€/2)
        const targetRotation = (3 * Math.PI / 2) - targetPrizeAngle;
        // Add multiple full rotations for spinning effect
        const fullRotations = 5 + Math.random() * 3; // 5-8 full rotations
        const finalRotation = targetRotation + (fullRotations * 2 * Math.PI);

        // Animate spin
        const startRotation = rotation;
        const rotationDiff = finalRotation - startRotation;
        const duration = 3000; // 3 seconds
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function (ease-out)
            const easeOut = 1 - Math.pow(1 - progress, 3);
            
            rotation = startRotation + (rotationDiff * easeOut);
            drawWheel();

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            } else {
                // Animation complete
                spinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ¡';
                
                // Decrease remaining prizes count
                remainingPrizesCount = Math.max(0, remainingPrizesCount - 1);
                prizesCountEl.textContent = remainingPrizesCount;
                
                // Update participants count immediately
                updateParticipantsCount();
                
                // Show result with clear spin-again button
                resultText.innerHTML = `
                    <div class="result-card">
                        <h2>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ğŸ‰</h2>
                        <p class="result-prize"><strong>Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©:</strong> ${wonPrize}</p>
                        <div class="result-winner">
                            <p><strong>Ø§Ù„ÙØ§Ø¦Ø²:</strong> ${winner.name}</p>
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${winner.phone}</p>
                            <p><strong>Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ØµÙ„:</strong> ${winner.social_media_account}</p>
                            <p><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${winner.city}</p>
                        </div>
                        <button type="button" class="spin-again-btn" id="spinAgainBtn">Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ¡</button>
                    </div>
                `;
                document.getElementById('spinAgainBtn').addEventListener('click', function() {
                    resultText.innerHTML = '';
                    spinBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    spinWheel();
                });
                resultText.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        animate();

    } catch (error) {
        console.error('Error spinning wheel:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        spinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¬Ù„Ø© ğŸ¡';
    }
}

/**
 * Update participants count
 */
async function updateParticipantsCount() {
    try {
        const response = await fetch(`/influencers/participants-count/${influencerToken}/`);
        const result = await response.json();
        
        if (result.success) {
            participantsCountEl.textContent = result.count;
        }
    } catch (error) {
        console.error('Error updating participants count:', error);
    }
}

// Event listeners
spinBtn.addEventListener('click', spinWheel);
window.addEventListener('resize', function() { if (!spinning) drawWheel(); });
enablePrizeOrder?.addEventListener('change', applyPrizeOrderMode);

// Update participants count every 5 seconds
setInterval(updateParticipantsCount, 5000);

// Initial render
renderPrizeOrderList();
applyPrizeOrderMode();
</script>
{% endblock %}

